<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØµÙ…Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± - WhatsApp Reports</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            direction: rtl;
            text-align: right;
            font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #25D366;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .editor-panel {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }

        .editor-panel h3 {
            margin-bottom: 15px;
            color: #128C7E;
        }

        .preview-panel {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: #f9f9f9;
            min-height: 400px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .reports-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .report-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #25D366;
        }

        .report-card h3 {
            color: #128C7E;
            margin-bottom: 10px;
        }

        .report-card p {
            color: #666;
            margin-bottom: 15px;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .parameter-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .parameter-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        .send-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .preview-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            min-height: 300px;
        }

        .help-text {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #25D366;
        }

        .help-text code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ù…ØµÙ…Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h1>
            <p>ØµÙ…Ù… ØªÙ‚Ø§Ø±ÙŠØ±Ùƒ ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('design')">ØªØµÙ…ÙŠÙ… ØªÙ‚Ø±ÙŠØ±</button>
            <button class="tab" onclick="showTab('reports')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button>
            <button class="tab" onclick="showTab('send')">Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ±</button>
            <button class="tab" onclick="showTab('logs')">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ ØªØµÙ…ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
        <div id="design" class="tab-content active">
            <div class="help-text">
                <strong>ğŸ’¡ Ù†ØµÙŠØ­Ø©:</strong> Ø§Ø³ØªØ®Ø¯Ù… <code>{{Ø§Ø³Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„}}</code> ÙÙŠ HTML Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                <br>Ù…Ø«Ø§Ù„: <code>{{Ø§Ø³Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„}}</code> Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©
            </div>

            <form id="reportForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± *</label>
                    <input type="text" id="reportName" required placeholder="Ù…Ø«Ø§Ù„: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ">
                </div>

                <div class="form-group">
                    <label>ÙˆØµÙ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                    <textarea id="reportDescription" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±"></textarea>
                </div>

                <div class="editor-container">
                    <div class="editor-panel">
                        <h3>ğŸ“ HTML Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
                        <textarea id="reportHTML" class="code-editor" placeholder="<html>
<head>
    <style>
        body { font-family: Arial; padding: 20px; }
        h1 { color: #128C7E; }
    </style>
</head>
<body>
    <h1>ØªÙ‚Ø±ÙŠØ±: {{Ø§Ø³Ù…_Ø§Ù„ØªÙ‚Ø±ÙŠØ±}}</h1>
    <p>Ø§Ù„Ø¹Ù…ÙŠÙ„: {{Ø§Ø³Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„}}</p>
    <p>Ø§Ù„Ù…Ø¨Ù„Øº: {{Ø§Ù„Ù…Ø¨Ù„Øº}} Ø±ÙŠØ§Ù„</p>
</body>
</html>"></textarea>
                    </div>

                    <div class="preview-panel">
                        <h3>ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
                        <div class="preview-content" id="previewContent">
                            <p style="color: #999; text-align: center;">Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§...</p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="updatePreview()" style="margin-top: 10px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>CSS Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="reportCSS" class="code-editor" placeholder="body { background: #f5f5f5; }"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button type="button" class="btn btn-secondary" onclick="loadTemplate()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨</button>
            </form>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
        <div id="reports" class="tab-content">
            <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
            <div id="reportsList" class="reports-list">
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± -->
        <div id="send" class="tab-content">
            <h2>Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ±</h2>
            
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                <select id="sendReportId" class="form-group input" onchange="loadReportParameters()">
                    <option value="">-- Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ± --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ *</label>
                <input type="text" id="phoneNumber" required placeholder="966501234567" pattern="[0-9]+">
                <small style="color: #666;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† + Ø£Ùˆ Ù…Ø³Ø§ÙØ§Øª</small>
            </div>

            <div class="form-group">
                <label>Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙ‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="sendMessage" placeholder="Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© ØªØ±Ø³Ù„ Ù…Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"></textarea>
            </div>

            <div id="parametersContainer">
                <h3>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Parameters)</h3>
                <div id="parametersList"></div>
            </div>

            <button type="button" class="btn btn-success" onclick="sendReport()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
        <div id="logs" class="tab-content">
            <h2>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h2>
            <div id="logsList"></div>
        </div>
    </div>

    <script>
        let currentReport = null;
        let allReports = [];

        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'reports') {
                loadReports();
            } else if (tabName === 'send') {
                loadReportsForSend();
            } else if (tabName === 'logs') {
                loadLogs();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        function updatePreview() {
            const html = document.getElementById('reportHTML').value;
            const css = document.getElementById('reportCSS').value;
            const preview = document.getElementById('previewContent');
            
            let fullHTML = html;
            if (css) {
                fullHTML = fullHTML.replace('</head>', `<style>${css}</style></head>`);
            }
            
            preview.innerHTML = fullHTML;
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ù…Ø«Ø§Ù„
        function loadTemplate() {
            const template = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            margin: 0;
        }
        .report-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #128C7E;
            border-bottom: 3px solid #25D366;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #f9f9f9;
            margin: 10px 0;
            border-radius: 8px;
            border-right: 4px solid #25D366;
        }
        .label {
            font-weight: 600;
            color: #333;
        }
        .value {
            color: #128C7E;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="report-container">
        <h1>ğŸ“Š {{Ø§Ø³Ù…_Ø§Ù„ØªÙ‚Ø±ÙŠØ±}}</h1>
        
        <div class="info-row">
            <span class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
            <span class="value">{{Ø§Ø³Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„}}</span>
        </div>
        
        <div class="info-row">
            <span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span>
            <span class="value">{{Ø§Ù„Ù…Ø¨Ù„Øº}} Ø±ÙŠØ§Ù„</span>
        </div>
        
        <div class="info-row">
            <span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
            <span class="value">{{Ø§Ù„ØªØ§Ø±ÙŠØ®}}</span>
        </div>
        
        <div class="info-row">
            <span class="label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
            <span class="value">{{Ø§Ù„Ø­Ø§Ù„Ø©}}</span>
        </div>
        
        <div class="footer">
            <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        </div>
    </div>
</body>
</html>`;

            document.getElementById('reportHTML').value = template;
            document.getElementById('reportName').value = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª';
            document.getElementById('reportDescription').value = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠÙˆÙ…ÙŠ';
            updatePreview();
        }

        // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const reportData = {
                name: document.getElementById('reportName').value,
                description: document.getElementById('reportDescription').value,
                template_data: {
                    html: document.getElementById('reportHTML').value,
                    css: document.getElementById('reportCSS').value
                }
            };

            try {
                const response = await fetch('/api/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reportData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
                    document.getElementById('reportForm').reset();
                    showTab('reports');
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + result.error);
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        async function loadReports() {
            try {
                const response = await fetch('/api/reports');
                const result = await response.json();
                
                if (result.success) {
                    allReports = result.reports;
                    const listDiv = document.getElementById('reportsList');
                    
                    if (result.reports.length === 0) {
                        listDiv.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©</p>';
                        return;
                    }
                    
                    listDiv.innerHTML = result.reports.map(report => `
                        <div class="report-card">
                            <h3>${report.name}</h3>
                            <p>${report.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                            <small style="color: #999;">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(report.created_at).toLocaleDateString('ar-SA')}</small>
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="viewReport(${report.id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                <button class="btn btn-secondary" onclick="editReport(${report.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-danger" onclick="deleteReport(${report.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        async function loadReportsForSend() {
            try {
                const response = await fetch('/api/reports');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('sendReportId');
                    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ± --</option>' +
                        result.reports.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        async function loadReportParameters() {
            const reportId = document.getElementById('sendReportId').value;
            if (!reportId) return;

            try {
                const response = await fetch(`/api/reports/${reportId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentReport = result.report;
                    const html = result.report.template_data.html;
                    
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† HTML
                    const parameters = [];
                    const regex = /\{\{(\w+)\}\}/g;
                    let match;
                    const foundParams = new Set();
                    
                    while ((match = regex.exec(html)) !== null) {
                        foundParams.add(match[1]);
                    }
                    
                    const paramsList = document.getElementById('parametersList');
                    paramsList.innerHTML = '';
                    
                    if (foundParams.size === 0) {
                        paramsList.innerHTML = '<p style="color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>';
                        return;
                    }
                    
                    foundParams.forEach(param => {
                        const div = document.createElement('div');
                        div.className = 'parameter-input';
                        div.innerHTML = `
                            <label style="min-width: 150px;">${param}:</label>
                            <input type="text" id="param_${param}" placeholder="Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ${param}">
                        `;
                        paramsList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', error);
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        async function sendReport() {
            const reportId = document.getElementById('sendReportId').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const message = document.getElementById('sendMessage').value;
            
            if (!reportId || !phoneNumber) {
                alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
                return;
            }

            // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
            const parameters = {};
            document.querySelectorAll('#parametersList input').forEach(input => {
                const key = input.id.replace('param_', '');
                parameters[key] = input.value;
            });

            try {
                const response = await fetch(`/api/reports/${reportId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        parameters: parameters,
                        message: message
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
                    document.getElementById('phoneNumber').value = '';
                    document.getElementById('sendMessage').value = '';
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±'));
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        async function viewReport(id) {
            window.open(`/api/reports/${id}/view`, '_blank');
        }

        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        async function editReport(id) {
            try {
                const response = await fetch(`/api/reports/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const report = result.report;
                    document.getElementById('reportName').value = report.name;
                    document.getElementById('reportDescription').value = report.description || '';
                    document.getElementById('reportHTML').value = report.template_data.html || '';
                    document.getElementById('reportCSS').value = report.template_data.css || '';
                    
                    // Ø­ÙØ¸ ID Ù„Ù„ØªØ­Ø¯ÙŠØ«
                    document.getElementById('reportForm').dataset.reportId = id;
                    
                    showTab('design');
                    updatePreview();
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
            }
        }

        // Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        async function deleteReport(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ')) return;

            try {
                const response = await fetch(`/api/reports/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
                    loadReports();
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + result.error);
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const result = await response.json();
                
                if (result.success) {
                    const logsDiv = document.getElementById('logsList');
                    
                    if (result.logs.length === 0) {
                        logsDiv.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¥Ø±Ø³Ø§Ù„</p>';
                        return;
                    }
                    
                    logsDiv.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: #128C7E; color: white;">
                                    <th style="padding: 15px; text-align: right;">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                                    <th style="padding: 15px; text-align: right;">Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</th>
                                    <th style="padding: 15px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th style="padding: 15px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.logs.map(log => `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 12px;">${log.report_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td style="padding: 12px;">${log.recipient}</td>
                                        <td style="padding: 12px;">
                                            <span style="padding: 5px 10px; border-radius: 5px; background: ${log.status === 'sent' ? '#d4edda' : '#f8d7da'}; color: ${log.status === 'sent' ? '#155724' : '#721c24'};">
                                                ${log.status === 'sent' ? 'âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'âŒ ÙØ´Ù„'}
                                            </span>
                                        </td>
                                        <td style="padding: 12px;">${new Date(log.sent_at).toLocaleString('ar-SA')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        document.getElementById('reportHTML').addEventListener('input', () => {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© debounce Ù‡Ù†Ø§ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
        });
    </script>
</body>
</html>

