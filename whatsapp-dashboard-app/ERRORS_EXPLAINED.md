# شرح أخطاء السجلات (PM2 / الخادم)

## 1. JSON parsing error: Bad control character in string literal at position 68

**السبب:** الجسم المرسل في طلب `POST /api/.../send-message` يحتوي على أحرف تحكم غير مسموحة في JSON (مثل سطر جديد `\n` أو تاب داخل النص بدون escape).

**ما يحدث:** العميل يرسل رسالة فيها أسطر جديدة أو أحرف خاصة، وـ `express.json()` يفشل في التحليل.

**الحل في التطبيق:** تم تنقية الجسم (استبدال أحرف التحكم بمسافة) قبل التحليل. تأكد من نشر أحدث نسخة من `server.js`. إذا استمر الخطأ، تأكد أن الطرف المرسل لا يضع أحرف تحكم حرفية داخل حقل الرسالة.

---

## 2. Request URL: /api//wa_xxx/send-message (شرطة مزدوجة)

**السبب:** الرابط المُستدعى يحتوي على `//` بدل `/` بين `/api` ومفتاح الـ API (مثال: `/api//wa_xxx/...`).

**ما يحدث:** قد لا يُطابق المسار التوجيه الصحيح أو يُفسَّر مفتاح الـ API بشكل خاطئ.

**الحل في التطبيق:** تمت إضافة middleware يعيد تسوية المسار (دمج الشرطات المتتالية). الرابط الصحيح: `POST /api/wa_XXXXXXXX/send-message` مع الهيدر `x-session-token`.

---

## 3. ValidationError: X-Forwarded-For / trust proxy is false

**السبب:** الخادم يعمل خلف proxy (مثل nginx) الذي يضيف هيدر `X-Forwarded-For`، بينما إعداد Express الافتراضي `trust proxy` كان `false`.

**ما يحدث:** مكتبة express-rate-limit ترفض الطلب لأنها تتوقع تفعيل `trust proxy` عند وجود هذا الهيدر.

**الحل في التطبيق:** تفعيل `app.set('trust proxy', 1)` في بداية الإعداد. تأكد من نشر أحدث `server.js` وإعادة تشغيل PM2.

---

## 4. ProtocolError: Network.getResponseBody - No data found for resource

**السبب:** خطأ من Puppeteer/Chrome (CDP): طلب قراءة body لطلب شبكي انتهى أو لم يعد متوفراً (صفحة انتقلت، المورد أُزيل، إلخ).

**ما يحدث:** مكتبة whatsapp-web.js تحاول قراءة استجابة من صفحة واتساب ويب داخل المتصفح، والاستجابة لم تعد متاحة.

**الحل:** سلوك معروف أحياناً مع واتساب ويب. إعادة تشغيل الجلسة أو مسح QR من جديد عادة يحل المشكلة. لا يتطلب تغييراً في الكود.

---

## 5. auth timeout

**السبب:** انتهت مهلة انتظار ظهور عنصر المصادقة في صفحة واتساب ويب (الافتراضي 30 ثانية). يحدث على سيرفرات بطيئة أو عند تأخر تحميل الصفحة.

**ما يحدث:** المكتبة تنتظر `window.Debug?.VERSION` (أو شرط مصادقة) ولا يظهر في الوقت المحدد.

**الحل في التطبيق:** تم رفع مهلة المصادقة إلى 60 ثانية (`authTimeoutMs: 60000`) لجميع إنشاءات الـ Client. إذا استمر الخطأ، تحقق من أداء السيرفر واتصال الشبكة.

---

## 6. Execution context was destroyed

**السبب:** سياق تنفيذ الصفحة (execution context) في Puppeteer انتهى لأن الصفحة أُغلقت أو انتقلت أو تعطلت.

**ما يحدث:** عملية في الخلفية (مثل تهيئة الجلسة) حاولت تنفيذ سكربت في الصفحة بعد أن لم تعد الصفحة متاحة.

**الحل:** غالباً يتبع إغلاق المتصفح أو فشل التهيئة. إعادة تشغيل الجلسة وحذف أي متصفح قديم للجلسة نفسها (انظر "browser already running") يقلل التكرار.

---

## 7. The browser is already running for ... session-session_XX. Use a different userDataDir or stop the running browser first.

**السبب:** تم محاولة فتح عميل (Client) جديد لجلسة لها نفس مجلد المستخدم (userDataDir) بينما متصفح قديم لا يزال يعمل لهذه الجلسة (عملية Chrome زائدة أو لم تُغلق بعد إعادة التشغيل).

**ما يحدث:** وجود عمليتين لمجلد جلسة واحد يسبب تعارض قفل (SingletonLock) ورفض من Puppeteer.

**الحل في التطبيق:**
- قتل أي عمليات Chrome مرتبطة بالجلسة قبل فتح عميل جديد (`killChromeProcessesForSession` مع محاولتين على Linux).
- تنظيف مجلد الجلسة (ملفات القفل) قبل إنشاء الـ Client (`cleanupSessionFolder`) في كل من استعادة الجلسات وبدء الجلسة من الواجهة.
- منع بدء نفس الجلسة مرتين في وقت واحد (`sessionStartLocks`) حتى لا يُفتح عميلان لنفس الجلسة.

تأكد من نشر أحدث `server.js` و`session-manager.js` وإعادة تشغيل PM2.

---

## لماذا لا تتغير حالة الجلسة بعد مسح QR ولا تتصل؟

أهم سبب في سجلاتك هو **"The browser is already running"** لجلسة 24: كان هناك متصفح قديم لا يزال يعمل لنفس المجلد، فالمتصفح الجديد الذي يعرض الـ QR ليس هو الذي يملك القفل، أو يحدث تعارض بين عمليتين. عند مسح الـ QR يكمل الاتصال في المتصفح الذي يملك الجلسة؛ إذا كان هناك متصفح آخر (القديم) فهو الذي قد يستقبل الحدث، بينما الواجهة مرتبطة بالعميل الجديد الذي فشل. النتيجة: المستخدم يظن أن الجلسة لم تتصل.

بعد الإصلاحات:
1. قبل أي فتح لجلسة يتم قتل عمليات Chrome القديمة لهذه الجلسة وتنظيف القفل.
2. لا يُسمح ببدء نفس الجلسة مرتين في نفس الوقت.
3. مهلة المصادقة 60 ثانية لتقليل "auth timeout".

---

## 8. getChatModel: Cannot read properties of undefined (reading 'update')

**السبب:** استدعاء `client.getChats()` أو `client.getContacts()` فور حدث `authenticated` بينما الـ Store الداخلي في واتساب ويب لم يكتمل بعد.

**ما يحدث:** المكتبة تحاول قراءة نموذج المحادثات من الصفحة فيكون غير معرّف بعد.

**الحل في التطبيق:** تم إلغاء جلب المحادثات/الجهات من معالج حدث `authenticated`. جلب المحادثات والجهات يحدث فقط عند حدث `ready` (عند اكتمال الاتصال فعلياً).

---

## 9. الجلسة غير موجودة أو غير متصلة (SESSION_NOT_FOUND)

**السبب:** طلب إرسال رسالة بجلسة تم إيقافها من لوحة التحكم، أو أن العميل لم يُسجّل في `activeClients` (مثلاً بعد إعادة تشغيل تلقائي فاشل).

**ما يحدث:** الـ API يتحقق من وجود العميل في الذاكرة؛ إذا ضغط المستخدم "إيقاف" فتُحذف الجلسة من الذاكرة ويصبح إرسال الرسائل غير متاح حتى يعيد "بدء" الجلسة.

**ما يجب فعله:** إعادة "بدء الجلسة" من لوحة التحكم ثم إعادة المحاولة. رسالة SESSION_NOT_FOUND بعد الإيقاف متوقعة وليست خطأ في النظام.

---

**خطوات بعد النشر:**
1. رفع أحدث الملفات إلى السيرفر.
2. إعادة تشغيل التطبيق: `pm2 restart whatsapp-dashboard`
3. إذا استمرت مشكلة جلسة معيّنة: إيقاف الجلسة من الواجهة، ثم من السيرفر تنفيذ:  
   `pkill -f "session-session_XX"` (استبدل XX بمعرف الجلسة)، ثم بدء الجلسة من جديد من الواجهة.
