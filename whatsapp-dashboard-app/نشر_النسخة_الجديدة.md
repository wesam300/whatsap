# نشر النسخة الجديدة مع الحفاظ على بيانات الإنتاج

## الهدف
التحديث إلى النسخة الجديدة **بدون تغيير أي شيء للمستخدمين**: نفس المستخدمين، نفس الجلسات، نفس الصلاحيات والاشتراكات، وبدون مشاكل في التشغيل.

---

## 1. التوافق مع قاعدة البيانات الحالية

- **لا حذف ولا تغيير لجدول المستخدمين أو الجلسات.**  
  الكود الجديد يعمل على نفس الجداول والأعمدة التي تستخدمها نسختك الحالية.

- **ترحيل تلقائي آمن عند أول تشغيل:**
  - إذا كان جدول `sessions` في نسختك القديمة **بدون** عمود `updated_at`، سيتم إضافته تلقائياً عند بدء التشغيل.
  - يتم تعبئة `updated_at` للصفوف القديمة من `created_at` (أو الوقت الحالي) حتى لا تتأثر منطق "انقطاع أكثر من 14 يوماً".
  - إذا كان العمود موجوداً أصلاً (قاعدة جديدة أو مسبقاً محدّثة) فلن يحدث أي تغيير على البنية.

- **لم نضف أعمدة إلزامية جديدة** على `users` أو غيرها؛ كل ما يحدث هو إضافة عمود اختياري للجلسات فقط عند الحاجة.

---

## 2. ما الذي **لا** يتغيّر أبداً

| العنصر | الوضع |
|--------|--------|
| حسابات المستخدمين (users) | بدون تغيير |
| أرقام/معرفات الجلسات (sessions.id) | بدون تغيير |
| صلاحية الجلسات (expires_at, days_remaining, max_days) | بدون تغيير |
| حالة الجلسات (status) وقيمها الحالية | بدون تغيير |
| بيانات الجلسة (session_data، QR، إلخ) | بدون تغيير |
| مفاتيح API وتوكنات الجلسات | بدون تغيير |
| الباقات والاشتراكات | بدون تغيير |

لا يوجد في الكود الجديد أي:
- حذف أو استبدال لجدول كامل
- تغيير في معنى أو استخدام `expires_at` أو صلاحية الاشتراك
- مسح لبيانات المستخدمين أو الجلسات

---

## 3. خطوات النشر الموصى بها (بدون توقّف اختياري)

1. **نسخ احتياطي**
   - نسخ ملف قاعدة البيانات: `whatsapp-dashboard-app/sessions/whatsapp_dashboard.db`
   - نسخ مجلد الجلسات بالكامل: `whatsapp-dashboard-app/sessions/` (مجلدات `session-session_*` وملفات الجلسات)
   - الاحتفاظ بالنسخة في مكان آمن حتى تتأكد أن التشغيل سليم.

2. **إيقاف الخدمة الحالية**
   - إيقاف عملية الـ Node الحالية (مثلاً `pm2 stop` أو إيقاف الخدمة في النظام).

3. **نشر الكود الجديد**
   - استبدال ملفات التطبيق بالنسخة الجديدة (أو `git pull` إن كنت تستخدم Git).
   - تشغيل `npm install` إن تغيّرت الحزم في `package.json`.

4. **تشغيل النسخة الجديدة**
   - تشغيل التطبيق كالمعتاد (مثلاً `npm start` أو `pm2 start`).
   - عند **أول تشغيل** سيتم تنفيذ الترحيل الآمن إن لزم (إضافة `updated_at` فقط إن لم يكن موجوداً وتعبيته من `created_at`).

5. **التحقق**
   - تسجيل الدخول بحساب مستخدم موجود.
   - التأكد من ظهور الجلسات نفسها وأرقامها وصلاحياتها.
   - التأكد من أن الاشتراكات والصلاحيات (expires_at، الأيام المتبقية) كما كانت.

---

## 4. إن حدثت مشكلة

- **استعد من النسخة الاحتياطية:**  
  أوقف التطبيق، استبدل `whatsapp_dashboard.db` ومجلد `sessions/` بالنسخة التي نسختها، ثم شغّل النسخة القديمة من الكود مرة أخرى.

- **في حال أخطاء متعلقة بقاعدة البيانات:**  
  راجع سجلات التشغيل (الكونسول أو الـ log file). الترحيل يُنفَّذ داخل `db.js` ويُحاط بـ try/catch حتى لا يسقُط التطبيق؛ إن ظهر خطأ فغالباً يكون العمود موجوداً مسبقاً ويُتجاهل.

---

## 5. ملخص

- **قاعدة البيانات:** متوافقة مع النسخة الحالية؛ التغيير الوحيد المحتمل هو إضافة عمود `updated_at` لجدول `sessions` عند الحاجة فقط.
- **المستخدمون والجلسات والصلاحيات:** لا يتغيّر شيء عليهم.
- **النسخة الجديدة:** مصممة لتعمل على نفس البيانات دون كسر الخدمة أو فقدان بيانات.

---
*آخر تحديث: 2025-02-24*
